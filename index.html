<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¸­å­¦ç”Ÿåœ¨çº¿å­¦ä¹ å¹³å°</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div id="app" class="flex h-screen overflow-hidden">

        <div v-if="!token" class="fixed inset-0 z-50 flex items-center justify-center bg-blue-600">
            <div class="bg-white p-10 rounded-3xl shadow-2xl w-96 transform transition-all hover:scale-105">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-blue-700">
                        {{ isLoginMode ? 'åœ¨çº¿å­¦ä¹ å¹³å°' : 'æ–°ç”¨æˆ·æ³¨å†Œ'}}
                    </h2>
                    <p class="text-slate-400 mt-2 italic">å­¦-ç»ƒ-æµ‹-æ”¹ é—­ç¯ç³»ç»Ÿ</p>
                </div>
                <div class="space-y-4">
                    <div class="relative"><i class="fas fa-user absolute left-3 top-3.5 text-slate-300"></i>
                        <input
                                v-model="form.username"
                                placeholder="ç”¨æˆ·å"
                                class="w-full pl-10 pr-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-400 focus:outline-none"
                                :class="{ 'border-red-500': form.username.length < 2 && form.username.length > 0 }"
                        >
                        <p v-if="form.username.length > 0 && form.username.length < 2" class="text-red-500 text-xs mt-1">ç”¨æˆ·åè‡³å°‘2ä¸ªå­—ç¬¦</p>
                    </div>

                    <div v-if="!isLoginMode" class="relative">
                        <i class="fas fa-graduation-cap absolute left-3 top-3.5 text-slate-300"></i>
                        <select v-model="form.grade" class="w-full pl-10 pr-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-400 focus:outline-none appearance-none bg-white">
                            <option value="" disabled>è¯·é€‰æ‹©å¹´çº§</option>
                            <option value="åˆä¸€">åˆä¸€</option>
                            <option value="åˆäºŒ">åˆäºŒ</option>
                            <option value="åˆä¸‰">åˆä¸‰</option>
                        </select>
                    </div>

                    <div class="relative"><i class="fas fa-lock absolute left-3 top-3.5 text-slate-300"></i>
                        <input
                                v-model="form.password"
                                type="password"
                                placeholder="å¯†ç "
                                class="w-full pl-10 pr-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-400 focus:outline-none"
                                :class="{ 'border-red-500': form.password.length < 6 && form.password.length > 0 }"
                        >
                        <p v-if="form.password.length > 0 && form.password.length < 6" class="text-red-500 text-xs mt-1">å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦</p>
                    </div>

                    <button @click="handleAuth" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 shadow-lg">
                        {{ isLoginMode ? 'ç™»å½•ç³»ç»Ÿ' : 'ç«‹å³æ³¨å†Œ' }}
                    </button>

                    <div class="text-center mt-4">
                        <a @click="isLoginMode = !isLoginMode" class="text-sm text-blue-600 cursor-pointer hover:underline">
                            {{ isLoginMode ? 'æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ' : 'å·²æœ‰è´¦å·ï¼Ÿå»ç™»å½•' }}
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <template v-else>
            <aside class="w-64 bg-blue-900 text-white flex flex-col shadow-xl">
                <div class="p-8 text-2xl font-black italic tracking-wider border-b border-blue-800">åœ¨çº¿å­¦ä¹ å¹³å°</div>
                <nav class="flex-1 p-4 space-y-2 mt-4">
                    <button v-for="tab in visibleTabs" @click="currentTab = tab.id"
                        :class="['w-full flex items-center p-4 rounded-2xl transition-all', currentTab === tab.id ? 'bg-blue-600 shadow-lg scale-105' : 'hover:bg-blue-800']">
                        <i :class="['fas mr-4 w-5', tab.icon]"></i> {{ tab.name }}
                    </button>
                </nav>
            </aside>

            <div class="flex-1 flex flex-col">
                <header class="h-20 bg-white shadow-sm flex items-center justify-between px-10 border-b border-slate-200">
                    <h2 class="text-xl font-bold text-slate-600">{{ visibleTabs.find(t=>t.id==currentTab).name }}</h2>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <p class="font-bold text-blue-600">{{ user.username }}</p>
                            <p class="text-xs text-slate-400">{{user.grade}}</p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-black border-2 border-blue-500 shadow-inner overflow-hidden">
                            <img v-if="user.avatar" :src="user.avatar" class="w-full h-full object-cover">
                            <span v-else>{{ user.username.charAt(0).toUpperCase() }}</span>
                        </div>
                        <button @click="logout" class="ml-4 text-slate-300 hover:text-red-500"><i class="fas fa-power-off"></i></button>
                    </div>
                </header>

                <main class="flex-1 overflow-y-auto p-10 bg-slate-50">

                    <div v-if="currentTab === 'course'" class="space-y-8">
                        <div class="grid grid-cols-4 gap-4">
                            <button v-for="s in subjects" @click="changeSubject(s)"
                                :class="['py-4 rounded-2xl font-bold transition-all shadow-sm', currentSubject==s ? 'bg-blue-600 text-white scale-105' : 'bg-white text-blue-600 hover:border-blue-400 border border-transparent']">
                                {{s}}
                            </button>
                        </div>
                        <div v-if="videoUrl" class="bg-white p-6 rounded-3xl shadow-xl aspect-video border border-slate-100 overflow-hidden">
                            <iframe :src="videoUrl" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>
                        </div>
                    </div>

                    <div v-if="currentTab === 'test'" class="max-w-3xl mx-auto space-y-6">
                        <div v-for="(q, idx) in questions" :key="q.id" class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                            <div class="flex justify-between mb-4"><span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-bold">{{currentSubject}}</span></div>
                            <p class="text-lg font-bold text-slate-700 leading-relaxed mb-6">{{idx+1}}. {{ q.content }}</p>
                            <div class="grid grid-cols-2 gap-4">
                                <button v-for="opt in ['A','B','C','D']"
                                        @click="submitAnswer(q.id, opt)"
                                        class="text-left px-6 py-4 border rounded-2xl hover:bg-blue-50 hover:border-blue-400 transition-all font-medium group">
                                    <span class="text-blue-600 mr-3 font-black text-lg">{{opt}}</span>

                                    <span class="text-slate-600">{{ parseOptions(q.options)[opt] }}</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentTab === 'wrong'" class="grid grid-cols-2 gap-6">
                        <div v-for="m in mistakes" :key="m.id" class="bg-white p-6 rounded-3xl border-l-8 border-red-500 shadow-sm relative overflow-hidden">
                            <div class="absolute right-[-10px] top-[-10px] opacity-10 text-6xl text-red-500"><i class="fas fa-times-circle"></i></div>
                            <p class="font-bold text-slate-800 mb-3">{{ m.content }}</p>
                            <p class="text-red-500 font-bold bg-red-50 p-2 rounded-lg inline-block text-sm">è§£æï¼š{{ m.answer }}</p>
                        </div>
                    </div>

                   <div v-if="currentTab === 'heatmap'" class="bg-white p-12 rounded-3xl shadow-xl text-center">
                        <h3 class="text-2xl font-bold text-slate-700 mb-10">
                            <i class="fas fa-fire text-orange-500 mr-2"></i> å­¦ä¹ æˆå°±çƒ­åŠ›å›¾
                        </h3>

                        <div class="w-full bg-slate-50 p-6 rounded-3xl overflow-x-auto custom-scrollbar">
                            <div class="flex justify-start md:justify-center">
                                <div class="grid grid-rows-7 grid-flow-col gap-1.5">
                                    <div v-for="day in 371" :key="day"
                                        :class="['w-3 h-3 rounded-sm transition-all', getHeatColor(day)]"
                                        :title="getDayStr(day)">
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-between items-center mt-6 text-xs text-slate-400 italic px-2 min-w-[800px]">
                                <span>æœ€è¿‘ä¸€å¹´å­¦ä¹ è¿›åº¦</span>
                                <div class="flex items-center gap-1">
                                    <span>å°‘</span>
                                    <div class="w-3 h-3 rounded-sm bg-slate-200"></div>
                                    <div class="w-3 h-3 rounded-sm bg-blue-300"></div>
                                    <div class="w-3 h-3 rounded-sm bg-blue-600"></div>
                                    <span>å¤š</span>
                                </div>
                            </div>
                        </div>

                        <p class="mt-8 text-slate-400 italic">é¢œè‰²è¶Šæ·±ä»£è¡¨å½“æ—¥åšé¢˜é‡è¶Šå¤šï¼Œç»§ç»­ä¿æŒï¼</p>
                    </div>

                    <div v-if="currentTab === 'profile'" class="max-w-md mx-auto">
                        <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-100">
                            <h3 class="text-2xl font-bold text-slate-700 mb-6 flex items-center">
                                <i class="fas fa-id-card text-blue-500 mr-3"></i> è´¦å·ä¿¡æ¯è®¾ç½®
                            </h3>

                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-500 mb-2">ç”¨æˆ·å</label>
                                    <div class="bg-slate-50 px-4 py-3 rounded-xl text-slate-400 border border-slate-100">
                                        {{ user.username }} (ä¸å¯ä¿®æ”¹)
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-500 mb-2">æ‰€å±å¹´çº§</label>
                                    <select v-model="user.grade" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-400 focus:outline-none bg-white">
                                        <option value="åˆä¸€">åˆä¸€</option>
                                        <option value="åˆäºŒ">åˆäºŒ</option>
                                        <option value="åˆä¸‰">åˆä¸‰</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-500 mb-2">æ–°å¯†ç </label>
                                    <input v-model="form.password" type="password" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç "
                                        class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-400 focus:outline-none">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-500 mb-2">ä¸Šä¼ å¤´åƒ</label>
                                    <div class="flex items-center gap-4">
                                        <label class="cursor-pointer bg-slate-100 px-4 py-2 rounded-xl border-2 border-dashed border-slate-300 hover:border-blue-400 text-slate-500 text-sm">
                                            <i class="fas fa-camera mr-2"></i>é€‰æ‹©å›¾ç‰‡
                                            <input type="file" class="hidden" @change="handleFileUpload" accept="image/*">
                                        </label>
                                        <img v-if="form.avatar" :src="form.avatar" class="w-12 h-12 rounded-full object-cover border-2 border-blue-500">
                                    </div>
                                </div>

                                <button @click="updateProfile" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 shadow-lg transition-all active:scale-95">
                                    ä¿å­˜ä¿®æ”¹
                                </button>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentTab === 'admin'" class="space-y-6">
                        <div class="flex gap-4 border-b border-slate-200 pb-4">
                            <button @click="adminSubTab = 'questions'" :class="adminSubTab === 'questions' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400'">é¢˜åº“ç®¡ç†</button>
                            <button @click="adminSubTab = 'courses'" :class="adminSubTab === 'courses' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400'">è¯¾ç¨‹ç®¡ç†</button>
                            <button @click="adminSubTab = 'users'" :class="adminSubTab === 'users' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400'">ç”¨æˆ·ç®¡ç†</button>
                            <button @click="adminSubTab = 'stats'" :class="adminSubTab === 'stats' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-400'">æ•°æ®ç»Ÿè®¡</button>
                        </div>

                        <div v-if="adminSubTab === 'questions'"> ... </div>
                        <div v-if="adminSubTab === 'courses'"> ... </div>
                        ...
                    </div>
                </main>
            </div>
        </template>
    </div>

    <script>
        const { createApp } = Vue;
        const API = "http://127.0.0.1:8000";

        createApp({
            data() {
                return {
                    isLoginMode: true,
                    adminSubTab: 'questions',
                    token: localStorage.getItem('token') || '',
                    user: { username: localStorage.getItem('username') || 'æœªç™»å½•' , grade: localStorage.getItem('grade') || '', avatar: localStorage.getItem('avatar') || ''},
                    form: { username: '', password: '', grade: 'åˆä¸€' , avatar: ''},
                    currentTab: 'course', currentSubject: 'æ•°å­¦', videoUrl: '',
                    questions: [], heatmap: {}, mistakes: [],
                    subjects: ['æ•°å­¦', 'ç‰©ç†', 'ç”Ÿç‰©', 'è¯­æ–‡', 'è‹±è¯­', 'åœ°ç†', 'é“æ³•', 'åŒ–å­¦'],
                    tabs: [
                        { id: 'course', name: 'è¯¾ç¨‹å­¦ä¹ ', icon: 'fa-tv' },
                        { id: 'test', name: 'åˆ·é¢˜æŒ‘æˆ˜', icon: 'fa-keyboard' },
                        { id: 'wrong', name: 'é”™é¢˜æ”¶çº³', icon: 'fa-folder-open' },
                        { id: 'heatmap', name: 'æˆå°±å‹‹ç« ', icon: 'fa-medal' },
                        { id: 'profile', name: 'ä¸ªäººèµ„æ–™', icon: 'fa-user' }
                    ]
                }
            },
            mounted() { if(this.token) { this.syncData(); } },
            computed: {
                visibleTabs() {
                    if (this.user.username === 'admin') {
                        return [
                            ...this.tabs,
                            { id: 'admin', name: 'ç³»ç»Ÿç®¡ç†', icon: 'fa-user-shield' }
                        ];
                    }
                    return this.tabs;
                }
            },
            methods: {
                async handleAuth() {

                    if (!this.form.username || this.form.username.length < 2) {
                        alert("ç”¨æˆ·åè‡³å°‘2ä¸ªå­—ç¬¦ï¼");
                        return; // è¿™é‡Œæ˜¯å…³é”®ï¼šä¸­æ­¢å‡½æ•°æ‰§è¡Œ
                    }
                    if (!this.form.password || this.form.password.length < 6) {
                        alert("å¯†ç è‡³å°‘6ä½ï¼");
                        return;
                    }
                    // 1. åˆ¤æ–­å½“å‰æ˜¯ç™»å½•è¿˜æ˜¯æ³¨å†Œ
                    if (this.isLoginMode) {
                        // æ‰§è¡Œç™»å½•é€»è¾‘ (è¿™é‡Œå¤ç”¨ä½ åŸæœ‰çš„ä»£ç )
                        try {
                            const res = await axios.post(`${API}/login`, this.form);
                            this.token = res.data.access_token;
                            this.user.username = res.data.username;
                            this.user.grade = res.data.grade;
                            this.user.avatar = res.data.avatar;

                            localStorage.setItem('token', this.token);
                            localStorage.setItem('username', this.user.username);
                            localStorage.setItem('grade', this.user.grade);
                            localStorage.setItem('avatar', this.user.avatar || '');

                            this.syncData();
                        } catch(e) {
                            alert("ç™»å½•å¤±è´¥ï¼šè¯·æ£€æŸ¥è´¦å·å¯†ç ");
                        }
                    } else {
                        // 2. æ‰§è¡Œæ³¨å†Œé€»è¾‘
                        try {
                            // è°ƒç”¨åç«¯çš„æ³¨å†Œæ¥å£
                            const res = await axios.post(`${API}/register`, this.form);

                            // æ³¨å†ŒæˆåŠŸåçš„å¤„ç†
                            alert("æ­å–œä½ ï¼Œæ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•");

                            // è‡ªåŠ¨æŠŠæ¨¡å¼åˆ‡å›â€œç™»å½•â€ï¼Œè®©ç”¨æˆ·è¾“å…¥åˆšæ‰æ³¨å†Œçš„è´¦å·
                            this.isLoginMode = true;

                            // å¯é€‰ï¼šæ¸…ç©ºå¯†ç æ¡†ï¼Œå¢åŠ å®‰å…¨æ€§
                            this.form.password = '';
                        } catch(e) {
                            // å¦‚æœåç«¯æŠ¥é”™ï¼ˆæ¯”å¦‚ç”¨æˆ·åå·²å­˜åœ¨ï¼‰ï¼Œæ•è·å¹¶æç¤º
                            const errorMsg = e.response?.data?.detail || "æ³¨å†Œå¤±è´¥ï¼Œè¯·æ¢ä¸ªç”¨æˆ·åè¯•è¯•";
                            alert(errorMsg);
                        }
                    }
                },
                logout() { localStorage.clear(); location.reload(); },
                async syncData() {
                    axios.defaults.headers.common['Authorization'] = `Bearer ${this.token}`;
                    try {
                        const hRes = await axios.get(`${API}/my/heatmap`); this.heatmap = hRes.data;
                        const mRes = await axios.get(`${API}/my/mistakes`); this.mistakes = mRes.data;
                        this.changeSubject(this.currentSubject);
                    } catch(e) { this.logout(); }
                },
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    // é™åˆ¶æ–‡ä»¶å¤§å°ï¼ˆæ¯”å¦‚ä¸è¶…è¿‡ 1MBï¼Œé˜²æ­¢æ•°æ®åº“è¿‡å¤§ï¼‰
                    if (file.size > 1024 * 1024) {
                        alert("å›¾ç‰‡å¤ªå¤§äº†ï¼Œè¯·ä¸Šä¼  1MB ä»¥å†…çš„å›¾ç‰‡");
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // e.target.result å°±æ˜¯è½¬æ¢åçš„ Base64 å­—ç¬¦ä¸²
                        this.form.avatar = e.target.result;
                    };
                    reader.readAsDataURL(file);
                },
                parseOptions(optionsStr) {
                    try {
                        // å°†åç«¯ä¼ æ¥çš„å­—ç¬¦ä¸²è§£æä¸º JS å¯¹è±¡
                        return JSON.parse(optionsStr);
                    } catch (e) {
                        // å¦‚æœé¢˜ç›®æ²¡æœ‰é€‰é¡¹ï¼ˆæ¯”å¦‚å¡«ç©ºé¢˜ï¼‰ï¼Œè¿”å›ç©ºå¯¹è±¡é˜²æ­¢æŠ¥é”™
                        return {};
                    }
                },
                async updateProfile() {
                        const updateData = { grade: this.user.grade };
                        if(this.form.password) updateData.password = this.form.password;

                        // å‘é€å¤´åƒ Base64 å­—ç¬¦ä¸²
                        if(this.form.avatar) updateData.avatar = this.form.avatar;

                        try {
                            await axios.put(`${API}/my/profile`, updateData);
                            alert("èµ„æ–™æ›´æ–°æˆåŠŸï¼");

                            // é‡è¦ï¼šæ›´æ–°å½“å‰æ˜¾ç¤ºçš„å¤´åƒå¹¶åŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨
                            if(this.form.avatar) {
                                this.user.avatar = this.form.avatar;
                                localStorage.setItem('avatar', this.form.avatar);
                            }
                            localStorage.setItem('grade', this.user.grade);
                            this.form.password = '';
                        } catch(e) {
                            alert("æ›´æ–°å¤±è´¥");
                        }
                    },
                async changeSubject(s) {
                    this.currentSubject = s;
                    const cRes = await axios.get(`${API}/courses/${s}`); this.videoUrl = cRes.data[0]?.video_url;
                    const qRes = await axios.get(`${API}/questions/${s}`); this.questions = qRes.data;
                },
                async submitAnswer(qid, ans) {
                    const res = await axios.post(`${API}/questions/submit`, { question_id: qid, user_answer: ans });
                    if(res.data.is_correct) alert("ğŸŒŸ å®Œç¾ï¼å›ç­”æ­£ç¡®");
                    else alert("ğŸ’¡ å·²è‡ªåŠ¨æ•´ç†è‡³é”™é¢˜æœ¬");
                    this.syncData();
                },
                getHeatColor(day) {
                    const d = this.getDayStr(day);
                    const c = this.heatmap[d] || 0;
                    if(c === 0) return 'bg-slate-200';
                    if(c < 3) return 'bg-blue-200';
                    if(c < 5) return 'bg-blue-300';
                    if(c < 7) return 'bg-blue-400';
                    if(c < 10) return 'bg-blue-500';
                    return 'bg-blue-600 shadow-sm';

                },
                getDayStr(day) {
                    const d = new Date();
                    d.setDate(d.getDate() - (371 - day));
                    return d.toISOString().split('T')[0];
                }
            }
        }).mount('#app');
    </script>
</body>
</html>